<!DOCTYPE html>
<html lang="kk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Batyr: Orbulaq Defence</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #121212;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            color: white;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            image-rendering: pixelated;
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #menuScreen,
        #pauseScreen,
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 10;
        }

        #pauseScreen {
            display: none;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        h1 {
            color: #f1c40f;
            text-shadow: 4px 4px #c0392b;
            font-size: 35px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }

        .hero-select {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .hero-card {
            border: 4px solid #555;
            padding: 20px;
            cursor: pointer;
            text-align: center;
            background: #222;
            transition: 0.2s;
            width: 200px;
        }

        .hero-card:hover {
            transform: scale(1.05);
        }

        .hero-card.selected {
            border-color: #f1c40f;
            background: #333;
            box-shadow: 0 0 15px #f1c40f;
        }

        .pixel-art-preview {
            width: 64px;
            height: 64px;
            margin: 0 auto 10px;
        }

        .stats {
            font-size: 10px;
            color: #aaa;
            line-height: 1.6;
            text-align: left;
            margin-top: 10px;
        }

        .stats span {
            display: block;
        }

        .stat-val {
            float: right;
            color: white;
        }

        #playBtn,
        .resume-btn {
            padding: 15px 40px;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
            background: #27ae60;
            border: 4px solid #2ecc71;
            color: white;
            cursor: pointer;
        }

        #playBtn:hover,
        .resume-btn:hover {
            background: #2ecc71;
        }

        #hud {
            display: none;
            padding: 20px;
            justify-content: space-between;
        }

        .weapon-slot {
            display: inline-block;
            width: 45px;
            height: 45px;
            border: 3px solid #555;
            background: rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 45px;
            font-size: 18px;
            margin-right: 8px;
            position: relative;
        }

        .weapon-slot.active {
            border-color: #f1c40f;
            box-shadow: 0 0 10px gold;
            transform: scale(1.1);
        }

        .count-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
        }

        .cooldown-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 0, 0, 0.7);
            height: 0%;
            transition: height 0.1s;
        }

        #waveText {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: #e74c3c;
            text-shadow: 3px 3px 0 #000;
            opacity: 0;
            transition: opacity 0.5s;
            text-align: center;
        }

        #gameOverScreen {
            display: none;
            z-index: 20;
        }

        .key {
            display: inline-block;
            padding: 5px 10px;
            border: 2px solid #aaa;
            border-radius: 5px;
            color: #f1c40f;
            margin: 0 5px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 45px;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            line-height: 1;
            transition: all 0.4s;
            z-index: 100;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }

        .back-btn:hover {
            color: #e74c3c;
            transform: rotate(90deg) scale(1.1);
            text-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
        }

        /* BUFF INDICATOR */
        #buffStatus {
            position: absolute;
            top: 80px;
            left: 20px;
            text-align: left;
            font-size: 12px;
        }

        .buff-row {
            margin-bottom: 5px;
            text-shadow: 1px 1px 0 #000;
        }
    </style>
</head>

<body>

    <button onclick="goBack()" class="back-btn">&times;</button>
    <canvas id="gameCanvas"></canvas>

    <div id="menuScreen">
        <h1>–û–†–ë“∞–õ–ê“ö: –®–ï–®–£–®–Ü –®–ê–ô“ö–ê–°</h1>
        <p style="margin-bottom: 20px; color: #aaa;">–ë–∞—Ç—ã—Ä–¥—ã —Ç–∞“£–¥–∞“£—ã–∑:</p>
        <div class="hero-select">
            <div class="hero-card selected" onclick="selectHero(0)">
                <div class="pixel-art-preview" style="background:#e74c3c"></div>
                <h3>–°–ê–õ“ö–ê–ú –ñ”ò“¢–ì–Ü–†</h3>
                <div class="stats"><span>‚ù§Ô∏è HP: <span class="stat-val">150</span></span><span>‚öîÔ∏è –ö“Ø—à: <span
                            class="stat-val">30</span></span><span>‚ö° –ñ—ã–ª–¥: <span class="stat-val">–û—Ä—Ç–∞</span></span>
                </div>
            </div>
            <div class="hero-card" onclick="selectHero(1)">
                <div class="pixel-art-preview" style="background:#3498db"></div>
                <h3>“ö–ê–†–ê–°–ê–ô –ë–ê–¢–´–†</h3>
                <div class="stats"><span>‚ù§Ô∏è HP: <span class="stat-val">250</span></span><span>‚öîÔ∏è –ö“Ø—à: <span
                            class="stat-val">20</span></span><span>‚ö° –ñ—ã–ª–¥: <span class="stat-val">–ë–∞—è—É</span></span>
                </div>
            </div>
            <div class="hero-card" onclick="selectHero(2)">
                <div class="pixel-art-preview" style="background:#2ecc71"></div>
                <h3>–ê“í–´–ù–¢–ê–ô –ë–ê–¢–´–†</h3>
                <div class="stats"><span>‚ù§Ô∏è HP: <span class="stat-val">90</span></span><span>‚öîÔ∏è –ö“Ø—à: <span
                            class="stat-val">40</span></span><span>‚ö° –ñ—ã–ª–¥: <span class="stat-val">–¢–µ–∑</span></span>
                </div>
            </div>
        </div>
        <button id="playBtn" onclick="startGame()">–û–ô–ù–ê–£ ‚ñ∂</button>
    </div>

    <div id="pauseScreen">
        <h1>–ü–ê–£–ó–ê II</h1>
        <h2>
            <span class="key">A</span> <span class="key">D</span> - –ñ“Ø—Ä—É &nbsp; <span class="key">SPACE</span> -
            –°–µ–∫—ñ—Ä—É<br><br>
            <span class="key">–õ–ö–ú</span> - “∞—Ä—É<br><br>
            <span class="key">1-6</span> - “ö–∞—Ä—É–ª–∞—Ä<br><br>
            <span class="key">P</span> - –û–π—ã–Ω“ì–∞ “õ–∞–π—Ç—É
        </h2>
        <button class="resume-btn" onclick="togglePause()">–ñ–ê–õ“í–ê–°–¢–´–†–£</button>
    </div>

    <div class="ui-layer">
        <div id="hud">
            <div style="display:flex; align-items:center;">
                <div class="weapon-slot active" id="slot1">üó°Ô∏è</div>
                <div class="weapon-slot" id="slot2">üèπ <span class="count-badge" id="ammoDisplay">20</span></div>
                <div class="weapon-slot" id="slot3">üß™ <div class="cooldown-overlay" id="gasCooldown"></div>
                </div>
                <div class="weapon-slot" id="slot4">‚ù§Ô∏è <div class="cooldown-overlay" id="medCooldown"></div>
                </div>
                <div class="weapon-slot" id="slot5">üî´ <span class="count-badge" id="musketDisplay">3</span></div>
                <div class="weapon-slot" id="slot6">üõ°Ô∏è</div>
            </div>
            <div style="text-align: right;">
                <div style="color: #f1c40f;">–ñ–ê–£–õ–ê–†: <span id="enemiesLeft">0</span></div>
                <div style="color: #e74c3c; font-size: 14px; margin-top:8px;">–¢–û–õ“ö–´–ù: <span id="waveDisplay">1</span>
                </div>
            </div>
        </div>
        <div id="buffStatus"></div>
        <div id="waveText"></div>
    </div>

    <div id="gameOverScreen">
        <h1 id="endTitle">–ñ–ï“¢–Ü–õ–Ü–°...</h1>
        <p id="endSub" style="margin-bottom:20px;">–ñ–æ“£“ì–∞—Ä–ª–∞—Ä –±–∞—Å—ã–º —Ç“Ø—Å—Ç—ñ.</p>
        <button id="playBtn" onclick="location.reload()">“ö–ê–ô–¢–ê –û–ô–ù–ê–£ ‚Üª</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        window.goBack = function () {
            sessionStorage.setItem('skipIntro', 'true');
            window.location.href = 'index.html';
        };

        // VARIABLES
        let gameState = 'MENU';
        let frame = 0;
        let wave = 1;
        let enemies = [], allies = [], particles = [], projectiles = [], damageTexts = [], gasClouds = [], buffs = [];
        let groundY = canvas.height - 100;
        let enemiesToSpawn = 0, spawnTimer = 0, cooldownTimer = 0;
        let buffSpawnTimer = 0; // 20 —Å–µ–∫ —Å–∞–Ω–∞—É—ã—à

        const HEROES = [
            { name: "–ñ”ô“£–≥—ñ—Ä", color: "#e74c3c", hp: 150, maxHp: 150, dmg: 30, speed: 5, jump: -15 },
            { name: "“ö–∞—Ä–∞—Å–∞–π", color: "#3498db", hp: 250, maxHp: 250, dmg: 20, speed: 3, jump: -12 },
            { name: "–ê“ì—ã–Ω—Ç–∞–π", color: "#2ecc71", hp: 90, maxHp: 90, dmg: 40, speed: 7, jump: -18 }
        ];
        let selectedHeroIdx = 0;

        const player = {
            x: 200, y: 0, w: 40, h: 60, vx: 0, vy: 0, color: '', facingRight: true,
            weapon: 1, arrows: 20, musketAmmo: 3,
            gasReady: true, gasCooldownTime: 0,
            medkitReady: true, medkitCooldownTime: 0,
            stats: {}, isAttacking: false,
            // –ë–ê–§–§–¢–ê–†–î–´“¢ –ö“Æ–ô–Ü
            invincibleTimer: 0,    // –©–∏—Ç (3 —Å–µ–∫)
            damageBoostTimer: 0    // –£—Ä–æ–Ω x2 (2 —Å–µ–∫)
        };

        const keys = { w: false, a: false, s: false, d: false, space: false };

        window.addEventListener('keydown', e => {
            if (e.code === 'Space') keys.space = true;
            if (e.key.toLowerCase() === 'a') keys.a = true;
            if (e.key.toLowerCase() === 'd') keys.d = true;
            if (['1', '2', '3', '4', '5', '6'].includes(e.key)) switchWeapon(parseInt(e.key));
            if (e.key.toLowerCase() === 'p') togglePause();
        });
        window.addEventListener('keyup', e => {
            if (e.code === 'Space') keys.space = false;
            if (e.key.toLowerCase() === 'a') keys.a = false;
            if (e.key.toLowerCase() === 'd') keys.d = false;
        });
        window.addEventListener('mousedown', attack);

        function selectHero(idx) {
            selectedHeroIdx = idx;
            document.querySelectorAll('.hero-card').forEach((c, i) => c.classList.toggle('selected', i === idx));
        }

        function togglePause() {
            if (gameState === 'PLAYING') { gameState = 'PAUSED'; document.getElementById('pauseScreen').style.display = 'flex'; }
            else if (gameState === 'PAUSED') { gameState = 'PLAYING'; document.getElementById('pauseScreen').style.display = 'none'; gameLoop(); }
        }

        function startGame() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            const h = HEROES[selectedHeroIdx];
            player.stats = { ...h };
            player.color = h.color;
            player.y = groundY - player.h;
            player.x = 200;
            player.hp = player.stats.maxHp;
            gameState = 'PLAYING';
            startWave(1);
            gameLoop();
        }

        function switchWeapon(id) {
            player.weapon = id;
            document.querySelectorAll('.weapon-slot').forEach((s, i) => s.classList.toggle('active', i + 1 === id));
        }

        function attack() {
            if (gameState !== 'PLAYING') return;
            if (player.weapon === 6) return; // –©–∏—Ç–ø–µ–Ω —à–∞–±—É—ã–ª –∂–æ“õ

            // –£–†–û–ù–î–´ –ï–°–ï–ü–¢–ï–£ (–ë–ê–§–§ –ë–û–õ–°–ê x2)
            let currentDmg = player.stats.dmg * (player.damageBoostTimer > 0 ? 2 : 1);

            if (player.weapon === 1) {
                player.isAttacking = true;
                setTimeout(() => player.isAttacking = false, 200);
                const reach = 60;
                const hitX = player.facingRight ? player.x + player.w : player.x - reach;
                enemies.forEach(e => {
                    if (rectIntersect(hitX, player.y, reach, player.h, e.x, e.y, e.w, e.h)) {
                        damageEnemy(e, currentDmg);
                        spawnParticles(e.x + e.w / 2, e.y + e.h / 2, '#ecf0f1', 5);
                    }
                });
            } else if (player.weapon === 2 && player.arrows > 0) {
                player.arrows--; document.getElementById('ammoDisplay').innerText = player.arrows;
                projectiles.push({ x: player.x + 20, y: player.y + 20, vx: player.facingRight ? 15 : -15, vy: -2, type: 'arrow', dmg: currentDmg * 0.8, color: '#ecf0f1' });
            } else if (player.weapon === 3 && player.gasReady) {
                player.gasReady = false; player.gasCooldownTime = 20000;
                gasClouds.push({ x: player.x, y: groundY - 50, w: 150, h: 100, life: 500, dmg: 10 * (player.damageBoostTimer > 0 ? 2 : 1) });
            } else if (player.weapon === 4 && player.medkitReady) {
                if (player.hp < player.stats.maxHp) {
                    player.medkitReady = false; player.medkitCooldownTime = 15000;
                    player.hp = Math.min(player.hp + 50, player.stats.maxHp);
                    showDamage(player.x, player.y - 20, "+50 HP", "#2ecc71");
                    spawnParticles(player.x, player.y, "#e74c3c", 10);
                }
            } else if (player.weapon === 5 && player.musketAmmo > 0) {
                player.musketAmmo--; document.getElementById('musketDisplay').innerText = player.musketAmmo;
                projectiles.push({ x: player.x + 20, y: player.y + 25, vx: player.facingRight ? 25 : -25, vy: 0, type: 'bullet', dmg: 80 * (player.damageBoostTimer > 0 ? 2 : 1), color: '#f1c40f' });
                player.vx = player.facingRight ? -5 : 5;
            }
        }

        function startWave(n) {
            wave = n; enemies = []; document.getElementById('waveDisplay').innerText = wave;
            if (wave === 1) enemiesToSpawn = 10;
            else if (wave === 2) enemiesToSpawn = 15;
            else if (wave === 3) enemiesToSpawn = 20;
            else if (wave === 4) { enemiesToSpawn = 25; spawnAllies(); }
            else if (wave === 5) enemiesToSpawn = 1;

            const wt = document.getElementById('waveText');
            wt.innerHTML = wave === 5 ? "–§–ò–ù–ê–õ<br>“ö–û–ù–¢–ê–ô–®–´ üëπ" : wave + "-–®–Ü –¢–û–õ“ö–´–ù";
            wt.style.color = "#e74c3c"; wt.style.opacity = 1;
            setTimeout(() => wt.style.opacity = 0, 3000);
        }

        function spawnAllies() {
            const wt = document.getElementById('waveText');
            wt.innerHTML = "–ö”®–ú–ï–ö –ö–ï–õ–î–Ü!<br>–ñ–ê–õ–ê“¢–¢”®–° –ë–ê“∫–ê–î“Æ–†"; wt.style.color = "#f1c40f"; wt.style.opacity = 1;
            allies.push({ x: -100, y: groundY - 60, w: 45, h: 65, hp: 500, maxHp: 500, color: "#8e44ad", name: "–ñ–ê–õ–ê“¢–¢”®–°", speed: 4, dmg: 30 });
            for (let i = 0; i < 10; i++) setTimeout(() => allies.push({ x: -50 - (i * 30), y: groundY - 60, w: 40, h: 60, hp: 100, maxHp: 100, color: "#3498db", name: "–°–∞—Ä–±–∞–∑", speed: 3, dmg: 10 }), i * 500);
        }

        function spawnEnemy() {
            if (enemiesToSpawn <= 0) return;
            let isBoss = (wave === 5);
            let side = Math.random() > 0.5 ? -50 : canvas.width + 50;
            enemies.push({
                x: side, y: groundY - (isBoss ? 120 : 60), w: isBoss ? 80 : 40, h: isBoss ? 120 : 60,
                hp: isBoss ? 2000 : 60 + (wave * 10), maxHp: isBoss ? 2000 : 60 + (wave * 10),
                speed: isBoss ? 3 : 2 + Math.random(), color: isBoss ? '#f1c40f' : '#7f8c8d',
                name: isBoss ? "“ö–û–ù–¢–ê–ô–®–´" : "–ñ–æ“£“ì–∞—Ä", isBoss: isBoss, attackCooldown: 0
            });
            enemiesToSpawn--;
        }

        // –ë–ê–§–§–¢–ê–†–î–´ –¢–£–î–´–†–£
        function spawnBuff() {
            // –¢“Ø—Ä–ª–µ—Ä—ñ: 0 - Heal, 1 - Shield, 2 - Damage
            const type = Math.floor(Math.random() * 3);
            const x = Math.random() * (canvas.width - 40) + 20;
            buffs.push({ x: x, y: -50, w: 30, h: 30, type: type, vy: 2 });
        }

        function gameLoop() {
            if (gameState === 'PAUSED') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            drawEntities();
            drawUI();

            if (gameState === 'COOLDOWN') {
                cooldownTimer--;
                if (cooldownTimer <= 0) { gameState = 'PLAYING'; startWave(wave + 1); }
                requestAnimationFrame(gameLoop); return;
            }

            if (gameState === 'PLAYING') {
                updatePhysics();
                updateEntities();
                updateAllies();

                // –ë–ê–§–§ –°–ü–ê–í–ù (1200 —Ñ—Ä–µ–π–º = 20 —Å–µ–∫ @ 60fps)
                buffSpawnTimer++;
                if (buffSpawnTimer >= 1200) {
                    spawnBuff();
                    buffSpawnTimer = 0;
                }

                // –ë–ê–§–§ –¢–ê–ô–ú–ï–†–õ–ï–†–Ü–ù –ê–ó–ê–ô–¢–£
                if (player.invincibleTimer > 0) player.invincibleTimer--;
                if (player.damageBoostTimer > 0) player.damageBoostTimer--;

                // Buff UI Update
                const buffDiv = document.getElementById('buffStatus');
                let html = '';
                if (player.invincibleTimer > 0) html += `<div class="buff-row" style="color:#3498db">üõ°Ô∏è “ö–ê–õ“ö–ê–ù: ${(player.invincibleTimer / 60).toFixed(1)}—Å</div>`;
                if (player.damageBoostTimer > 0) html += `<div class="buff-row" style="color:#e74c3c">‚ö° x2 –£–†–û–ù: ${(player.damageBoostTimer / 60).toFixed(1)}—Å</div>`;
                buffDiv.innerHTML = html;

                frame++;
            }
            requestAnimationFrame(gameLoop);
        }

        function updatePhysics() {
            if (keys.a) player.vx = -player.stats.speed;
            else if (keys.d) player.vx = player.stats.speed;
            else player.vx = 0;
            if (player.vx > 0) player.facingRight = true; if (player.vx < 0) player.facingRight = false;
            if (keys.space && player.y + player.h >= groundY) player.vy = player.stats.jump;
            player.vy += 0.8; player.x += player.vx; player.y += player.vy;
            if (player.y + player.h > groundY) { player.y = groundY - player.h; player.vy = 0; }
            if (player.x < 0) player.x = 0; if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;

            if (!player.gasReady) { player.gasCooldownTime -= 16; if (player.gasCooldownTime <= 0) player.gasReady = true; document.getElementById('gasCooldown').style.height = Math.min(100, (player.gasCooldownTime / 20000) * 100) + "%"; } else document.getElementById('gasCooldown').style.height = "0%";
            if (!player.medkitReady) { player.medkitCooldownTime -= 16; if (player.medkitCooldownTime <= 0) player.medkitReady = true; document.getElementById('medCooldown').style.height = Math.min(100, (player.medkitCooldownTime / 15000) * 100) + "%"; } else document.getElementById('medCooldown').style.height = "0%";
        }

        function updateAllies() {
            allies.forEach(a => {
                let target = null, minDist = 9999;
                enemies.forEach(e => { let d = Math.abs(a.x - e.x); if (d < minDist) { minDist = d; target = e; } });
                if (target) {
                    if (a.x < target.x - 30) a.x += a.speed; else if (a.x > target.x + 30) a.x -= a.speed;
                    else if (Math.random() < 0.05) { damageEnemy(target, a.dmg); ctx.fillStyle = "#fff"; ctx.fillRect(a.x + (a.x < target.x ? a.w : -20), a.y + 20, 20, 5); }
                } else if (a.x < player.x - 100) a.x += a.speed; else if (a.x > player.x + 100) a.x -= a.speed;
                if (a.y + a.h < groundY) a.y += 5;
            });
        }

        function updateEntities() {
            spawnTimer++; if (spawnTimer > 100 && enemiesToSpawn > 0) { spawnEnemy(); spawnTimer = 0; }

            // –ë–∞—Ñ—Ñ—Ç–∞—Ä “õ–æ–∑“ì–∞–ª—ã—Å—ã
            for (let i = buffs.length - 1; i >= 0; i--) {
                let b = buffs[i];
                if (b.y < groundY - 30) b.y += b.vy; // –ñ–µ—Ä–≥–µ —Ç“Ø—Å–∫–µ–Ω—à–µ “õ“±–ª–∞–π–¥—ã
                // –û–π—ã–Ω—à—ã –∞–ª–¥—ã –º–∞?
                if (rectIntersect(player.x, player.y, player.w, player.h, b.x, b.y, b.w, b.h)) {
                    if (b.type === 0) { // Heal
                        player.hp = Math.min(player.hp + 20, player.stats.maxHp);
                        showDamage(player.x, player.y - 30, "+20 HP", "#2ecc71");
                    } else if (b.type === 1) { // Shield
                        player.invincibleTimer = 180; // 3 sec (60fps * 3)
                        showDamage(player.x, player.y - 30, "IMMORTAL!", "#3498db");
                    } else if (b.type === 2) { // Damage
                        player.damageBoostTimer = 120; // 2 sec
                        showDamage(player.x, player.y - 30, "X2 DMG!", "#e74c3c");
                    }
                    buffs.splice(i, 1);
                }
            }

            enemies.forEach(e => {
                let target = player, minDist = Math.abs(e.x - player.x);
                allies.forEach(a => { let d = Math.abs(e.x - a.x); if (d < minDist) { minDist = d; target = a; } });
                if (Math.abs(target.x - e.x) > 5) e.x += (target.x > e.x ? 1 : -1) * e.speed;
                if (rectIntersect(target.x, target.y, target.w, target.h, e.x, e.y, e.w, e.h)) {
                    if (e.attackCooldown <= 0) {
                        if (target === player) {
                            // –ï–≥–µ—Ä –ò–ú–ú–£–ù–ò–¢–ï–¢ –±–æ–ª—Å–∞ - —É—Ä–æ–Ω –∞–ª–º–∞–π–¥—ã
                            if (player.invincibleTimer > 0) {
                                showDamage(player.x, player.y - 40, "“ö–û–†“í–ê–õ–î–´", "#3498db");
                            } else {
                                let dmg = 10;
                                if (player.weapon === 6) { dmg = Math.floor(dmg * 0.3); showDamage(player.x, player.y - 40, "–ë–õ–û–ö!", "#3498db"); }
                                player.hp -= dmg; showDamage(player.x, player.y, "-" + dmg, "#e74c3c");
                            }
                        }
                        e.attackCooldown = 60;
                    }
                }
                if (e.attackCooldown > 0) e.attackCooldown--;
            });

            if (player.hp <= 0) { gameState = 'GAMEOVER'; document.getElementById('gameOverScreen').style.display = 'flex'; }

            // Projectiles, Gas, Death logic (Same as before)
            for (let i = projectiles.length - 1; i >= 0; i--) { let p = projectiles[i]; p.x += p.vx; p.y += p.vy; if (p.type === 'arrow') p.vy += 0.1; if (p.x < 0 || p.x > canvas.width || p.y > groundY) { projectiles.splice(i, 1); continue; } let hit = false; enemies.forEach(e => { if (!hit && rectIntersect(p.x, p.y, 10, 5, e.x, e.y, e.w, e.h)) { damageEnemy(e, p.dmg); hit = true; } }); if (hit) projectiles.splice(i, 1); }
            for (let i = gasClouds.length - 1; i >= 0; i--) { let g = gasClouds[i]; g.life--; if (frame % 20 === 0) enemies.forEach(e => { if (rectIntersect(g.x - g.w / 2, g.y, g.w, g.h, e.x, e.y, e.w, e.h)) damageEnemy(e, g.dmg) }); if (g.life <= 0) gasClouds.splice(i, 1); }
            for (let i = enemies.length - 1; i >= 0; i--) { if (enemies[i].hp <= 0) { if (enemies[i].isBoss) setTimeout(() => { gameState = 'GAMEOVER'; document.getElementById('gameOverScreen').style.display = 'flex'; document.getElementById('endTitle').innerText = "–ñ–ï“¢–Ü–°! üèÜ"; document.getElementById('endTitle').style.color = "#f1c40f"; document.getElementById('endSub').innerText = "–ë–∞—Ç—ã—Ä –µ–ª–¥—ñ “õ–æ—Ä“ì–∞–ø “õ–∞–ª–¥—ã!"; }, 1000); enemies.splice(i, 1); } }

            if (enemies.length === 0 && enemiesToSpawn === 0) { if (wave < 5) { gameState = 'COOLDOWN'; cooldownTimer = 180; player.hp = Math.min(player.hp + 50, player.stats.maxHp); player.arrows = 20; document.getElementById('ammoDisplay').innerText = 20; const wt = document.getElementById('waveText'); wt.innerText = "–î–µ–º–∞–ª—ã—Å... (3 —Å–µ–∫)"; wt.style.color = "#2ecc71"; wt.style.opacity = 1; } }
            document.getElementById('enemiesLeft').innerText = enemies.length + enemiesToSpawn;
            particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life--; if (p.life <= 0) particles.splice(i, 1); });
            damageTexts.forEach((t, i) => { t.y -= 1; t.life--; if (t.life <= 0) damageTexts.splice(i, 1); });
        }

        function drawBackground() {
            ctx.fillStyle = "#2c3e50"; ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(200, 150); ctx.lineTo(500, groundY); ctx.fill();
            ctx.fillStyle = "#34495e"; ctx.beginPath(); ctx.moveTo(400, groundY); ctx.lineTo(canvas.width - 200, 100); ctx.lineTo(canvas.width, groundY); ctx.fill();
            for (let i = 0; i < canvas.width; i += 20) { ctx.fillStyle = "#27ae60"; ctx.fillRect(i, groundY, 20, 20); ctx.fillStyle = "#795548"; ctx.fillRect(i, groundY + 20, 20, canvas.height - groundY - 20); }
        }

        function drawEntities() {
            ctx.fillStyle = "rgba(46, 204, 113, 0.4)"; gasClouds.forEach(g => ctx.fillRect(g.x - g.w / 2, g.y, g.w, g.h));
            allies.forEach(a => drawPixelChar(a.x, a.y, a.w, a.h, a.color, false, true, a.name, a.hp, a.maxHp));

            // –ë–ê–§–§–¢–ê–†–î–´ –°–ê–õ–£
            buffs.forEach(b => {
                ctx.font = "20px serif";
                ctx.textAlign = "center";
                if (b.type === 0) ctx.fillText("üíö", b.x + 15, b.y + 20);
                else if (b.type === 1) ctx.fillText("üõ°Ô∏è", b.x + 15, b.y + 20);
                else ctx.fillText("‚ö°", b.x + 15, b.y + 20);

                // “ö–æ—Ä–∞–ø—à–∞
                ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.strokeRect(b.x, b.y, b.w, b.h);
            });

            // –û–π—ã–Ω—à—ã–Ω—ã –≤–∏–∑—É–∞–ª–¥—ã ”©–∑–≥–µ—Ä—Ç—É (–ë–∞—Ñ—Ñ –±–æ–ª—Å–∞)
            if (player.invincibleTimer > 0) {
                ctx.beginPath(); ctx.arc(player.x + player.w / 2, player.y + player.h / 2, 40, 0, Math.PI * 2);
                ctx.strokeStyle = "#3498db"; ctx.lineWidth = 3; ctx.stroke();
            }
            if (player.damageBoostTimer > 0) {
                ctx.shadowBlur = 15; ctx.shadowColor = "red"; // “ö—ã–∑—ã–ª –∂–∞—Ä“õ—ã–ª
            }

            drawPixelChar(player.x, player.y, player.w, player.h, player.color, true, player.facingRight, player.stats.name, player.hp, player.stats.maxHp);
            ctx.shadowBlur = 0; // –ñ–∞—Ä“õ—ã–ª–¥—ã ”©—à—ñ—Ä—É

            if (player.weapon === 6) { ctx.fillStyle = "#3498db"; let shieldX = player.facingRight ? player.x + player.w : player.x - 10; ctx.fillRect(shieldX, player.y + 10, 10, 40); }
            else if (player.isAttacking && player.weapon === 1) { ctx.fillStyle = "#bdc3c7"; let swX = player.facingRight ? player.x + player.w : player.x - 40; ctx.fillRect(swX, player.y + 20, 40, 10); }

            enemies.forEach(e => drawPixelChar(e.x, e.y, e.w, e.h, e.color, false, e.x < player.x, e.name, e.hp, e.maxHp));
            projectiles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.type === 'bullet' ? 10 : 20, 5); });
            particles.forEach(p => { ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.s, p.s); });
            ctx.font = "15px 'Press Start 2P'"; ctx.textAlign = "start";
            damageTexts.forEach(t => { ctx.fillStyle = t.c; ctx.fillText(t.val, t.x, t.y); });
        }

        function drawPixelChar(x, y, w, h, color, isHero, facingRight, name, hp, maxHp) {
            ctx.fillStyle = color; ctx.fillRect(x, y, w, h);
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(x + w - 5, y, 5, h);
            ctx.fillStyle = "white"; let eyeX = facingRight ? x + w - 15 : x + 5; ctx.fillRect(eyeX, y + 10, 10, 10);
            ctx.fillStyle = "black"; ctx.fillRect(facingRight ? eyeX + 5 : eyeX, y + 12, 5, 5);
            if (Math.abs(player.vx) > 0 || !isHero) { ctx.fillStyle = "#222"; let legOffset = Math.sin(frame * 0.2) * 5; ctx.fillRect(x + 5, y + h, 10, 5 + legOffset); ctx.fillRect(x + w - 15, y + h, 10, 5 - legOffset); }
            ctx.fillStyle = "white"; ctx.font = "10px sans-serif"; ctx.textAlign = "center"; ctx.fillText(name, x + w / 2, y - 15);
            let hpY = y + h + 15; let hpPerc = Math.max(0, hp / maxHp); ctx.fillStyle = "red"; ctx.fillRect(x, hpY, w, 5); ctx.fillStyle = "#2ecc71"; ctx.fillRect(x, hpY, w * hpPerc, 5);
        }

        function drawUI() { /* HUD handles this */ }
        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) { return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1; }
        function damageEnemy(e, amount) { e.hp -= amount; showDamage(e.x, e.y, "-" + Math.floor(amount), "#fff"); spawnParticles(e.x + e.w / 2, e.y + e.h / 2, e.color, 5); }
        function showDamage(x, y, val, color) { damageTexts.push({ x: x, y: y, val: val, c: color, life: 60 }); }
        function spawnParticles(x, y, color, count) { for (let i = 0; i < count; i++) particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 30, c: color, s: Math.random() * 5 + 2 }); }
    </script>
</body>

</html>